(function(n,t){var i=angular.module("admin",["ngRoute","ui.bootstrap","ui.codemirror","ui.select","ngSanitize","toaster","angular-dygraphs"]);i.config(["$routeProvider",function(n){n.when("/",{templateUrl:"/app/admin/devices.min.html",controller:"deviceController"}).when("/variables/:gateway/:device",{templateUrl:"/app/admin/variables.min.html",controller:"variableController"}).when("/variable/:variable/history",{templateUrl:"/app/admin/variablehistory.min.html",controller:"variableHistoryController"}).when("/scripts",{templateUrl:"/app/admin/scripts.min.html",controller:"scriptController"}).when("/scripts/:id",{templateUrl:"/app/admin/script.min.html",controller:"scriptDetailController"}).when("/rooms",{templateUrl:"/app/admin/rooms.min.html",controller:"roomController"}).when("/rooms/:id",{templateUrl:"/app/admin/room.min.html",controller:"roomDetailController"}).when("/group/:id",{templateUrl:"/app/admin/scriptgroup.min.html",controller:"scriptGroupController"}).when("/log",{templateUrl:"/app/admin/log.min.html",controller:"logController"})}]);i.filter("titlecase",function(){return function(n){return n.toUpperCase()[0]+n.substr(1)}});i.factory("$storage",["$window",function(n){return{get:function(t){var i=n.localStorage[t];return i?JSON.parse(i):null},set:function(t,i){n.localStorage[t]=JSON.stringify(i)},remove:function(t){n.localStorage.removeItem(t)}}}]);i.controller("installController",["$http",function(n){var t=this;t.yes=function(){n.post("/api/v1/softwareupdate/start")}}]);i.controller("navigationController",["$rootScope","$location",function(n,t){var i=this;n.$on("$locationChangeSuccess",function(){i.path=t.path()})}]);i.controller("deviceController",["$scope","$log","$http","$location","$uibModal",function(t,i,r,u,f){var e={},o;t.gateways=[];t.gatewaysWithFactory=[];o=function(i){r.get("/api/v1/gateway/"+i.name,{cache:!1}).then(function(u){var f=n.sortBy(u.data,function(n){return n.name});n.each(f,function(n){n.icon||(n.icon="fa fa-envelope-o")});i.devices=f;r.get("/api/v1/roomdevice/"+i.name,{cache:!1}).then(function(r){n.each(r.data,function(r){var u=n.find(t.rooms,function(n){return n.id===r.roomId}),f=n.find(i.devices,function(n){return n.id===r.deviceId});u&&f&&(f.room=u)})})})};r.get("/api/v1/room",{cache:!1}).then(function(n){t.rooms=n.data});r.get("/api/v1/gateway",{cache:!1}).then(function(i){var r=n.sortBy(i.data,function(n){return n.name});n.each(r,function(n){var i={name:n.name,canCreateDevices:n.canCreateDevices,devices:[]};e[n.name]=i;t.gateways.push(i);n.canCreateDevices&&t.gatewaysWithFactory.push(i.name)});n.each(t.gateways,o)});t.execute=function(n,t,i,u){u||(u={});r.post("/api/v1/action/"+n+"/"+t+"/"+i,u)};t.delete=function(t,i){r.delete("/api/v1/gateway/"+t+"?deviceId="+i).then(function(){e[t].devices=n.filter(e[t].devices,function(n){return n.id!==i})})};t.showVariables=function(n,t){u.path("/variables/"+n+"/"+t)};t.roomSelected=function(n,t,i){var u={gatewayName:n.name,deviceId:t.id,roomId:i?i.id:""};i||(t.room=null);r.post("/api/v1/roomdevice",u)};t.addDevice=function(n){r.get("/api/v1/gateway/"+n+"/empty").then(function(t){var i=f.open({animation:!1,templateUrl:"/app/admin/createDeviceDialog.min.html",controller:"createDeviceController",resolve:{device:function(){return t.data},gateway:function(){return n}}});i.result.then(function(t){r.post("/api/v1/gateway/"+n,t).then(function(){var t=e[n];o(t)})})})}}]);i.controller("createDeviceController",["$scope","$log","$uibModalInstance","gateway","device",function(t,i,r,u,f){t.device=f;t.gateway=u;t.keys=n.keys(f);t.ok=function(){r.close(f)};t.cancel=function(){r.dismiss("cancel")}}]);i.controller("variableController",["$scope","$routeParams","$log","$http","$location",function(t,i,r,u,f){var e=i.gateway,o=i.device,s=encodeURIComponent(o);t.actions=[];t.webHooks=[];u.get("/api/v1/variable/"+e+"?deviceId="+s,{cache:!1}).then(function(n){t.variables=n.data});u.get("/api/v1/gateway/"+e,{cache:!1}).then(function(i){var r=n.find(i.data,function(n){return n.id===o});r&&(t.deviceName=r.name,t.gateway=e,t.deviceId=o)});u.get("/api/v1/gateway/"+e+"/"+o+"/actions",{cache:!1}).then(function(i){n.each(i.data,function(n){t.actions.push({name:n.name,fields:n.fields.join(", ")})})});u.get("/api/v1/webhook/"+e+"/"+o,{cache:!1}).then(function(n){t.webHooks=n.data});t.showHistory=function(n){var t=encodeURIComponent(e),i=encodeURIComponent(o),r=encodeURIComponent(n);f.path("/variable/"+t+"."+i+"."+r+"/history")}}]);i.controller("variableHistoryController",["$scope","$routeParams","$log","$http",function(t,i,r,u){var f=i.variable;t.variable=f;u.get("/api/v1/variable/history?variable="+f,{cache:!1}).then(function(i){var r=[];n.each(i.data,function(n){var i=new Date(n.effectiveDate),t=n.value;(t===!1?t=0:t===!0&&(t=1),t instanceof String)||r.push([i,t])});t.data=r});t.data=[];t.options={legend:"always",showRangeSelector:!0,stepPlot:!0,showLabelsOnHighlight:!1}}]);i.controller("scriptController",["$scope","$log","$http","$location","$uibModal",function(n,t,i,r,u){n.scripts=[];i.get("/api/v1/script",{cache:!1}).then(function(t){n.scripts=t.data});n.enable=function(n){i.post("/api/v1/script/"+n.id+"/enable").then(function(){n.isEnabled=!0})};n.disable=function(n){i.post("/api/v1/script/"+n.id+"/disable").then(function(){n.isEnabled=!1})};n.openScript=function(n){r.path("/scripts/"+n)};n.delete=function(t){i.delete("/api/v1/script/"+t.id).then(function(){var i=n.scripts.indexOf(t);n.scripts.splice(i,1)})};n.createScript=function(){var t=u.open({animation:!1,templateUrl:"/app/admin/singleInputDialog.min.html",controller:"singleInputController",resolve:{caption:function(){return"Create Script"},label:function(){return"Name"},value:function(){return""}}});t.result.then(function(t){i.post("/api/v1/script","'"+t+"'").then(function(t){n.openScript(t.data.id.replace(/-/g,""))})})}}]);i.controller("singleInputController",["$scope","$log","$uibModalInstance","caption","label","value",function(n,t,i,r,u,f){n.caption=r;n.label=u;n.value=f;n.ok=function(){i.close(n.value)};n.cancel=function(){i.dismiss("cancel")}}]);i.controller("scriptDetailController",["toaster","$scope","$log","$http","$routeParams","$uibModal","$interval",function(t,i,r,u,f,e,o){var s=f.id,h,c,l;i.triggers=[];i.schedules=[];i.isSaving=!1;i.isExecuting=!1;h=function(){u.get("/api/v1/trigger/"+s,{cache:!1}).then(function(t){n.each(t.data,function(t){n.find(i.triggers,function(n){return n.variable===t.variable})||(t.value="",i.triggers.push(t))});n.each(i.triggers,function(r){if(!n.find(t.data,function(n){return r.variable===n.variable})){var u=i.triggers.indexOf(r);i.triggers.splice(u,1)}})})};c=function(){u.get("/api/v1/schedule/"+s,{cache:!1}).then(function(n){i.schedules=n.data})};u.get("/api/v1/script/"+s,{cache:!1}).then(function(n){i.script=n.data});h();c();i.save=function(){i.isSaving||(i.isSaving=!0,u.post("/api/v1/script/"+s,i.script).then(function(){i.isSaving=!1},function(){i.isSaving=!1}))};i.execute=function(){i.isExecuting||(i.isExecuting=!0,u.post("/api/v1/script/execute/"+s).then(function(){i.isExecuting=!1},function(){i.isExecuting=!1}))};i.enable=function(){u.post("/api/v1/script/"+s+"/enable").then(function(){i.script.isEnabled=!0})};i.disable=function(){u.post("/api/v1/script/"+s+"/disable").then(function(){i.script.isEnabled=!1})};i.addTrigger=function(){var n=e.open({animation:!1,templateUrl:"/app/admin/singleInputDialog.min.html",controller:"singleInputController",resolve:{caption:function(){return"Add Trigger"},label:function(){return"Variable name"},value:function(){return""}}});n.result.then(function(n){u.post("/api/v1/trigger/"+s,"'"+n+"'").then(h)})};i.removeTrigger=function(n){u.delete("/api/v1/trigger/"+n.id).then(h)};i.addSchedule=function(){var n=e.open({animation:!1,templateUrl:"/app/admin/singleInputDialog.min.html",controller:"singleInputController",resolve:{caption:function(){return"Add Schedule"},label:function(){return"Cron tab"},value:function(){return""}}});n.result.then(function(n){u.post("/api/v1/schedule/"+s,"'"+n+"'").then(function(){c()},function(){t.pop({type:"error",title:"Error",body:"Unable to save schedule with cron tab "+n,timeout:3e3})})})};i.removeSchedule=function(n){u.delete("/api/v1/schedule/"+n.id).then(c)};shortcut.add("Ctrl+S",function(){i.save()});l=o(function(){n.each(i.triggers,function(n){u.get("/api/v1/variable/"+n.variable,{cache:!1}).then(function(t){n.value=t.data.value;n.unit=t.data.unit;n.type=t.data.type})})},5e3);i.$on("$destroy",function(){o.cancel(l);shortcut.remove("Ctrl+S")})}]);i.controller("roomController",["$scope","$http","$uibModal","$location",function(t,i,r,u){t.rooms=[];var f=function(){i.get("/api/v1/room",{cache:!1}).then(function(i){t.rooms=i.data;n.each(t.rooms,function(n){n.id=n.id.replace(/-/g,"");n.icon===""&&(n.icon="glyphicon glyphicon-align-justify")})})};f();t.showRoom=function(n){u.path("/rooms/"+n)};t.addRoom=function(){var n=r.open({animation:!1,templateUrl:"/app/admin/singleInputDialog.min.html",controller:"singleInputController",resolve:{caption:function(){return"Add room"},label:function(){return"Name"},value:function(){return""}}});n.result.then(function(n){i.post("/api/v1/room","'"+n+"'").then(f)})}}]);i.controller("roomDetailController",["$scope","$log","$http","$routeParams","$uibModal","$location",function(n,t,i,r,u,f){var e=r.id,o;n.room={};n.groups=[];i.get("/api/v1/room/"+e,{cache:!1}).then(function(t){n.room=t.data});n.save=function(){i.put("/api/v1/room",n.room)};o=function(){i.get("/api/v1/roomscriptgroup?roomId="+e,{cache:!1}).then(function(t){n.groups=t.data})};o();n.openGroup=function(n){n=n.replace(/-/g,"");f.path("/group/"+n)};n.addScriptGroup=function(){var n=u.open({animation:!1,templateUrl:"/app/admin/singleInputDialog.min.html",controller:"singleInputController",resolve:{caption:function(){return"Add room script group"},label:function(){return"Name"},value:function(){return""}}});n.result.then(function(n){var t={name:n};i.post("/api/v1/roomscriptgroup/"+e,t).then(o)})}}]);i.controller("scriptGroupController",["$scope","$http","$routeParams","$uibModal",function(t,i,r,u){var o=r.id,e=[],f;t.group={};t.scripts=[];f=function(){i.get("/api/v1/roomscript?groupId="+o,{cache:!1}).then(function(i){t.scripts=i.data;n.each(t.scripts,function(t){t.id=t.id.replace(/-/g,"");t.scriptId=t.scriptId.replace(/-/g,"");t.script=n.find(e,function(n){return n.id===t.scriptId})})})};i.get("/api/v1/roomscriptgroup/"+o).then(function(n){t.group=n.data});i.get("/api/v1/script",{cache:!1}).then(function(n){e=n.data;f()});f();t.save=function(){i.post("/api/v1/roomscriptgroup",t.group)};t.addScript=function(){var n=u.open({animation:!1,templateUrl:"/app/admin/roomScriptDialog.min.html",controller:"roomScriptController",resolve:{caption:function(){return"Add room script"},script:function(){return{}},scripts:function(){return e}}});n.result.then(function(n){n.scriptId=n.script.id;n.groupId=o;i.post("/api/v1/roomscript",n).then(f)})};t.updateScript=function(n){var t=u.open({animation:!1,templateUrl:"/app/admin/roomScriptDialog.min.html",controller:"roomScriptController",resolve:{caption:function(){return"Update room script"},script:function(){return n},scripts:function(){return e}}});t.result.then(function(n){n.scriptId=n.script.id;i.post("/api/v1/roomscript/"+n.id,n).then(f)})}}]);i.controller("roomScriptController",["$scope","$uibModalInstance","caption","script","scripts",function(n,t,i,r,u){n.script=r;n.scripts=u;n.caption=i;n.ok=function(){t.close(n.script)};n.cancel=function(){t.dismiss("cancel")}}]);i.controller("logController",["$scope",function(n){var i=t.hubConnection(),r=i.createHubProxy("loggingHub");r.on("onLoggedEvent",function(n,i){var u=t("<td>").css("white-space","nowrap").text(i.TimeStamp),f=t("<td>").text(i.Level),e=t("<td>").text(i.Message),r=t("<tr>").append(u,f,e);i.Level==="WARN"?r.css("background-color","#FFFFCC"):i.Level==="DEBUG"?r.css("color","lightgray"):i.Level==="ERROR"&&r.css("background-color","#FF9966");t("#log-table tbody").append(r)});i.start();n.$on("$destroy",function(){i&&i.stop()})}]);i.controller("updateController",["$scope","toaster","$http","$interval","$timeout","$storage",function(n,i,r,u,f,e){function l(){function n(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}var o=t.hubConnection(),h=o.createHubProxy("notificationHub"),c,s;h.on("onNotification",function(n){i.pop({type:"info",title:new Date(n.Timestamp).toLocaleString(),body:n.Message,timeout:0})});o.start().done(function(){var n=e.get("signalr.notificationhub.id");n||(n=l(),e.set("signalr.notificationhub.id",n));h.invoke("register",n)});n.$on("$destroy",function(){o&&o.stop()});c=function(){i.pop("info","Update available","softwareUpdateTemplate.min.html",null,"template")};s=function(){r.get("/api/v1/softwareupdate/hasNewVersion",{cache:!1}).then(function(n){n.data===!0&&c()})};f(s,6e4);u(s,36e5)}])})(_,window.jQuery);