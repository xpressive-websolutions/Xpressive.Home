(function(n,t){var i=angular.module("xpressivehome",["ngRoute","ui.bootstrap","rzModule","rx"]);i.controller("dateTimeController",["$log","$interval",function(n,t){var i=this;t(function(){i.date=new Date},1e3)}]);i.controller("backgroundController",["$interval","$scope",function(n,t){var e=this,i=["spring","summer","autumn","winter"],r=["night","morning","afternoon","evening"],u=function(){var u="",f="",o=new Date,n=o.getMonth(),t=o.getHours();u=n<2?i[3]:n<5?i[0]:n<8?i[1]:n<11?i[2]:i[3];f=t<6?r[0]:t<12?r[1]:t<18?r[2]:r[3];e.selection=u+"-"+f},f;u();f=n(u,1e4);t.$on("$destroy",function(){n.cancel(f)})}]);i.controller("roomController",["$rootScope","$log","$http",function(i,r,u){var f=this;f.rooms=[];f.groups=[];f.room=null;f.selectRoom=function(n){f.room=n;i.$broadcast("selectedRoomChanged",n);u.get("/api/v1/roomscriptgroup?roomId="+n.id,{cache:!1}).then(function(n){var i=t.sortBy(n.data,function(n){return n.sortOrder});t.each(i,function(n){n.scripts=[]});f.groups=i;t.each(f.groups,function(n){u.get("/api/v1/script/group/"+n.id,{cache:!1}).then(function(t){n.scripts=t.data})})})};f.selectScript=function(n){u.post("/api/v1/script/execute/"+n.id)};f.toggle=function(t){var h=n("#"+t)[0].getBoundingClientRect(),r=n("#"+t).find(".dropdown-menu")[0],u=n(window).height(),i=n(r).actualHeight()*1.3+12,f="90%",e="5%",o,s;i<120&&(i=120);i<u*.9&&(o=i/u,s=(1-o)/2,f=Math.round(i)+"px",e=Math.round(s*100)+"%");r.style.left=h.left+"px";r.style.height=f;r.style.top=e};u.get("/api/v1/room",{cache:!1}).then(function(n){f.rooms=t.sortBy(n.data,function(n){return n.sortOrder});!f.room&&f.rooms&&f.selectRoom(f.rooms[0])})}]);i.controller("weatherController",["$log","$http","$interval","$scope",function(n,i,r,u){var f=this,h=["clear-night","partly-cloudy-night","clear-day","wind","partly-cloudy-day","fog","cloudy","rain","snow","sleet","hail","thunderstorm","tornado"],e=function(){return{name:"",tempMin:1e3,tempMax:-1e3,icon:"",prefixes:[]}},s,o;f.isEnabled=!1;f.forecast=[];f.forecast.push(e());f.forecast.push(e());f.forecast.push(e());f.forecast.push(e());f.variables=[];s=function(){i.get("/api/v1/gateway/Weather",{cache:!1}).then(function(n){if(n.data){var r=n.data[0];f.isEnabled=!0;f.forecast[0].name="Current";f.forecast[0].prefixes.push("");i.get("/api/v1/variable/Weather?deviceId="+r.id,{cache:!1}).then(function(n){for(var l=new Date,r=l.getHours(),a=6-r%6,v=["Night","Morning","Afternoon","Evening"],s=0,e=[],o,c,u,s=r<6?0:r<12?1:r<18?2:3,i=0;i<3;i++){for(o=i*6+a,c=o+6,u=o;u<c;u++)f.forecast[i+1].prefixes.push("H+"+u+"_");f.forecast[i+1].name=v[(i+s+1)%4]}t.each(n.data,function(n){e[n.name]=n.value});t.each(f.forecast,function(n){t.each(n.prefixes,function(t){var i=e[t+"Temperature"],r=e[t+"Icon"],u,f;n.tempMin>i&&(n.tempMin=i);n.tempMax<i&&(n.tempMax=i);n.icon===""?n.icon=r:(u=h.indexOf(n.icon),f=h.indexOf(r),f>u&&(n.icon=r))});n.tempMin=Math.round(n.tempMin,0);n.tempMax=Math.round(n.tempMax,0);n.icon="wi wi-forecast-io-"+n.icon;n.prefixes=[]})})}},function(){f.isEnabled=!1})};o=null;i.get("/api/v1/gateway",{cache:!1}).then(function(n){t.find(n.data,function(n){return n.name==="Weather"})&&(s(),o=r(s,6e5))});u.$on("$destroy",function(){o&&r.cancel(o)})}]);i.controller("musicController",["$rootScope","$scope","$log","$http","$uibModal","$interval","$q","observeOnScope",function(n,i,r,u,f,e,o,s){var h=this,l=[],a=[],v=null,c=new Date,y;h.isEnabled=!1;h.device=null;h.isPlaying=!1;h.deviceVolume=0;i.volume=0;s(i,"volume").sample(1e3).subscribe(function(n){Math.abs(h.deviceVolume-n.newValue)<2||(c=new Date,c.setSeconds(c.getSeconds()+10),h.deviceVolume=n.newValue,h.device&&u.post("/api/v1/radio/volume?deviceId="+encodeURIComponent(h.device.id)+"&volume="+h.deviceVolume))});y=function(){if(h.isEnabled=!1,h.device=null,l.length>0&&a.length>0&&v){var n=v.id.replace(/-/g,"");t.each(a,function(i){if(i.roomId.replace(/-/g,"")===n){var r=t.find(l,function(n){return n.id===i.deviceId});r&&(h.isEnabled=!0,h.device=r)}})}};u.get("/api/v1/gateway",{cache:!1}).then(function(n){if(t.find(n.data,function(n){return n.name==="Sonos"})){var i=u.get("/api/v1/gateway/Sonos",{cache:!1}),r=u.get("/api/v1/roomdevice/Sonos",{cache:!1});o.all([i,r]).then(function(n){l=n[0].data;a=n[1].data;y()})}});n.$on("selectedRoomChanged",function(n,t){v=t;y()});h.sliderOptions={floor:0,ceil:100,boundPointerLabels:!1,hidePointerLabels:!0,hideLimitLabels:!0,interval:1e3};h.togglePlay=function(){h.device&&(h.isPlaying?u.post("/api/v1/radio/stop?deviceId="+encodeURIComponent(h.device.id)).then(function(){h.isPlaying=!1}):u.post("/api/v1/radio/play?deviceId="+encodeURIComponent(h.device.id)).then(function(){h.isPlaying=!0}))};h.selectStation=function(){var n=f.open({templateUrl:"/app/musicSelectionController.min.html",controller:"musicSelectionController"});n.result.then(function(n){n.id===h.stationId&&h.isPlaying||(c=new Date,c.setSeconds(c.getSeconds()+10),h.stationId=n.id,h.station=n.name,h.imageUrl=n.imageUrl,h.playing="",h.device&&u.post("/api/v1/radio/play/radio?deviceId="+encodeURIComponent(h.device.id),n))},function(){h.stationId=null;h.station=null;h.imageUrl=null;h.playing=""})};e(function(){if(c>new Date){r.debug("skip");return}h.device&&u.get("/api/v1/variable/Sonos?deviceId="+encodeURIComponent(h.device.id)).then(function(n){t.each(n.data,function(n){if(n.name==="Volume")h.deviceVolume=n.value,i.volume=n.value;else if(n.name==="TransportState")h.isPlaying=n.value==="Playing";else if(n.name==="CurrentUri"){var t=/x-(?:rincon-mp3radio:\/\/|sonosapi-stream:)(s[0-9]+)\?.*/g.exec(n.value);t&&t.length===2&&(h.stationId=t[1])}})})},1e4);e(function(){h.stationId&&h.isPlaying&&u.get("/api/v1/radio/playing?stationId="+h.stationId,{cache:!1}).then(function(n){n.data?(h.imageUrl=n.data.playingImageUrl,h.playing=n.data.playing,h.station=n.data.name):(h.imageUrl=null,h.playing="",h.station="")},function(){h.imageUrl=null;h.playing=""})},1e4)}]);i.controller("musicSelectionController",["$scope","$http","$uibModalInstance",function(n,i,r){n.stations={};n.favorites=[];n.categories=[];n.query="";n.selected={};n.isOkEnabled=!1;i.get("/api/v1/radio/starred",{cache:!1}).then(function(t){n.favorites=t.data});i.get("/api/v1/radio/category").then(function(t){n.categories=t.data});n.search=function(){n.favorites=[];n.query&&i.get("/api/v1/radio/search?query="+encodeURIComponent(n.query)).then(function(t){n.stations=t.data})};n.star=function(n){i.put("/api/v1/radio/star",n)};n.unstar=function(t){i.put("/api/v1/radio/unstar",t).then(function(){n.favorites.splice(n.favorites.indexOf(t),1)})};n.selectCategory=function(t){n.favorites=[];i.get("/api/v1/radio/category?parentId="+t.id).then(function(t){n.categories=t.data});i.get("/api/v1/radio/station?categoryId="+t.id).then(function(t){n.stations=t.data})};n.selectStation=function(t){n.selected=t;n.isOkEnabled=!0};n.selectMoreStations=function(){if(n.stations.showMore){var r=n.stations.showMore;n.stations.showMore=null;i.get("/api/v1/radio/station?categoryId="+r).then(function(i){t.each(i.data.stations,function(t){n.stations.stations.push(t)});n.stations.showMore=i.data.showMore})}};n.ok=function(){r.close(n.selected)};n.cancel=function(){r.dismiss("cancel")}}])})($,_);